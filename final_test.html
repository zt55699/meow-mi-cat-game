<!DOCTYPE html>
<html>
<head>
    <title>Final Restart Test</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
    <style>
        body { font-family: Arial; margin: 20px; }
        #status { padding: 10px; border: 1px solid #ccc; margin: 10px 0; }
        .success { background-color: #d4f4dd; }
        .error { background-color: #f4d4d4; }
        .info { background-color: #d4e4f4; }
    </style>
</head>
<body>
    <h1>Final Restart System Test</h1>
    <div id="status" class="info">Starting test...</div>
    <div id="game"></div>
    
    <script>
        const status = document.getElementById('status');
        let testPhase = 0;
        let timersFired = 0;
        let restarted = false;
        
        function updateStatus(message, type = 'info') {
            status.className = type;
            status.textContent = `Phase ${testPhase}: ${message}`;
            console.log(message);
        }
        
        const config = {
            type: Phaser.AUTO,
            width: 600,
            height: 400,
            parent: 'game',
            physics: { default: 'arcade' },
            scene: {
                create: function() {
                    testPhase = 1;
                    updateStatus('Scene created, testing timer system...', 'info');
                    
                    // Test manual restart system
                    const instructions = this.add.text(300, 50, 'Manual Restart Test\nWait for timers to fire...', {
                        fontSize: '18px', fill: '#000000', align: 'center'
                    });
                    instructions.setOrigin(0.5);
                    
                    // Test button
                    const testBtn = this.add.text(300, 150, 'TRIGGER RESTART', {
                        fontSize: '20px', fill: '#ffffff', backgroundColor: '#007700', padding: {x: 15, y: 8}
                    });
                    testBtn.setOrigin(0.5);
                    testBtn.setInteractive();
                    
                    testBtn.on('pointerdown', () => {
                        if (!restarted) {
                            testManualRestart(this);
                        }
                    });
                    
                    // Start timer system
                    startTimerTest(this);
                }
            }
        };
        
        function startTimerTest(scene) {
            testPhase = 2;
            updateStatus('Creating test timers...', 'info');
            
            // Clear existing timers
            scene.time.removeAllEvents();
            
            // Create test timer
            scene.time.addEvent({
                delay: 1000,
                callback: function() {
                    timersFired++;
                    updateStatus(`Timer fired ${timersFired} times${restarted ? ' (after restart!)' : ''}`, 'success');
                    
                    if (timersFired === 3 && !restarted) {
                        testPhase = 3;
                        updateStatus('Timers working! Click TRIGGER RESTART to test restart system.', 'success');
                    } else if (timersFired >= 6 && restarted) {
                        testPhase = 5;
                        updateStatus('SUCCESS! Restart system works perfectly!', 'success');
                    }
                },
                callbackScope: scene,
                loop: true
            });
        }
        
        function testManualRestart(scene) {
            testPhase = 4;
            updateStatus('Testing manual restart (no scene.restart())...', 'info');
            restarted = true;
            
            // Manual restart like in fixed meow_mi
            scene.time.removeAllEvents(); // Clear timers
            
            // Reset state
            timersFired = 0;
            
            // Wait a bit then restart timers
            setTimeout(() => {
                updateStatus('Recreating timers after manual restart...', 'info');
                startTimerTest(scene);
            }, 100);
        }
        
        const game = new Phaser.Game(config);
        updateStatus('Initializing...', 'info');
    </script>
</body>
</html>