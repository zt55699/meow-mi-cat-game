<!DOCTYPE html>
<html>
<head>
    <title>Flow Test - Spawn System</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
    <style>
        body { font-family: Arial; }
        #logs { height: 200px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
        .log { margin: 2px 0; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>Spawn System Flow Test</h1>
    <div id="logs"></div>
    <div id="game"></div>
    
    <script>
        const logs = document.getElementById('logs');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = 'log ' + type;
            div.textContent = new Date().toLocaleTimeString() + ': ' + message;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }
        
        // Simulate the exact flow from meow_mi
        let gameStarted = false;
        let gameOver = false;
        let gameWon = false;
        let obstacles, fish;
        let spawnCount = 0;
        
        const config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            parent: 'game',
            physics: {
                default: 'arcade',
                arcade: { gravity: { y: 800 } }
            },
            scene: {
                create: function() {
                    log('üéÆ Scene created', 'success');
                    
                    // Create groups like in meow_mi
                    obstacles = this.physics.add.group();
                    fish = this.physics.add.group();
                    
                    log('üì¶ Groups created: obstacles=' + !!obstacles + ', fish=' + !!fish);
                    
                    // Start game immediately to test spawn
                    setTimeout(() => {
                        startGame(this);
                    }, 500);
                },
                
                update: function() {
                    if (!gameStarted || gameOver || gameWon) return;
                    
                    // Clean up objects like in meow_mi
                    obstacles.children.entries.forEach(obj => {
                        obj.x -= 3;
                        if (obj.x < -50) obj.destroy();
                    });
                    
                    fish.children.entries.forEach(obj => {
                        obj.x -= 3;
                        if (obj.x < -50) obj.destroy();
                    });
                }
            }
        };
        
        function startGame(scene) {
            log('üöÄ Starting game...', 'success');
            
            // Clear groups like in meow_mi
            if (obstacles) obstacles.clear(true, true);
            if (fish) fish.clear(true, true);
            
            gameStarted = true;
            gameOver = false;
            gameWon = false;
            
            // Remove existing timers like in meow_mi
            scene.time.removeAllEvents();
            
            log('‚è∞ Creating spawn timers...');
            
            // Create timers exactly like in meow_mi
            const obstacleTimer = scene.time.addEvent({
                delay: 2000,
                callback: function() {
                    log('üîÑ Obstacle timer fired - count: ' + (++spawnCount), 'success');
                    spawnObstacle(scene);
                },
                callbackScope: null,
                loop: true
            });
            
            const fishTimer = scene.time.addEvent({
                delay: 3000,
                callback: function() {
                    log('üêü Fish timer fired', 'success');
                    spawnFish(scene);
                },
                callbackScope: null,
                loop: true
            });
            
            log('‚úÖ Timers created: obstacle=' + !!obstacleTimer + ', fish=' + !!fishTimer);
            log('Timer details: obstacleDelay=' + obstacleTimer.delay + ', loop=' + obstacleTimer.loop);
            
            // Add test timer to verify timer system
            scene.time.addEvent({
                delay: 1000,
                callback: function() {
                    log('‚è±Ô∏è Test timer: ' + scene.time.now + ' - game state: started=' + gameStarted + ', over=' + gameOver);
                },
                callbackScope: null,
                loop: true
            });
            
            // Simulate game over after 10 seconds
            setTimeout(() => {
                log('üíÄ Simulating game over...', 'warning');
                gameOver = true;
                
                // Simulate restart after 3 seconds
                setTimeout(() => {
                    log('üîÑ Simulating restart...', 'warning');
                    scene.scene.restart();
                }, 3000);
            }, 10000);
        }
        
        function spawnObstacle(scene) {
            if (!gameStarted || gameOver || gameWon) {
                log('‚ùå Obstacle spawn blocked by game state', 'error');
                return;
            }
            
            // Create simple obstacle
            const obstacle = obstacles.create(850, 450, null);
            if (obstacle) {
                // Create visual representation
                const graphics = scene.add.graphics();
                graphics.fillStyle(0x8B4513);
                graphics.fillRect(0, 0, 50, 50);
                graphics.generateTexture('obstacle', 50, 50);
                obstacle.setTexture('obstacle');
                
                obstacle.setActive(true);
                obstacle.setVisible(true);
                obstacle.body.setAllowGravity(false);
                
                log('‚úÖ Obstacle created at x=' + obstacle.x + ', visible=' + obstacle.visible, 'success');
            } else {
                log('‚ùå Failed to create obstacle', 'error');
            }
        }
        
        function spawnFish(scene) {
            if (!gameStarted || gameOver || gameWon) {
                log('‚ùå Fish spawn blocked by game state', 'error');
                return;
            }
            
            // Create simple fish
            const f = fish.create(850, 350, null);
            if (f) {
                // Create visual representation
                const graphics = scene.add.graphics();
                graphics.fillStyle(0x1E90FF);
                graphics.fillCircle(20, 15, 20);
                graphics.generateTexture('fish', 40, 30);
                f.setTexture('fish');
                
                f.setActive(true);
                f.setVisible(true);
                f.body.setAllowGravity(false);
                
                log('‚úÖ Fish created at x=' + f.x + ', visible=' + f.visible, 'success');
            } else {
                log('‚ùå Failed to create fish', 'error');
            }
        }
        
        const game = new Phaser.Game(config);
        log('üéØ Test started - will simulate full game flow including restart');
    </script>
</body>
</html>