<!DOCTYPE html>
<html>
<head>
    <title>Manual Restart Test</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
</head>
<body>
    <div id="logs"></div>
    <div id="game"></div>
    
    <script>
        const logs = document.getElementById('logs');
        function log(msg) {
            logs.innerHTML += new Date().toLocaleTimeString() + ': ' + msg + '<br>';
            logs.scrollTop = logs.scrollHeight;
            console.log(msg);
        }
        
        let gameStarted = false;
        let gameOver = false;
        let timerCount = 0;
        let obstacles, fish;
        
        const config = {
            type: Phaser.AUTO,
            width: 600,
            height: 400,
            parent: 'game',
            physics: { default: 'arcade' },
            scene: {
                create: function() {
                    log('Scene created');
                    
                    // Create groups once
                    obstacles = this.physics.add.group();
                    fish = this.physics.add.group();
                    
                    // Start button
                    const startBtn = this.add.text(100, 100, 'START GAME', { 
                        fill: '#00ff00', fontSize: '20px', backgroundColor: '#000000', padding: {x: 10, y: 5}
                    });
                    startBtn.setInteractive();
                    startBtn.on('pointerdown', () => {
                        startBtn.destroy();
                        startTestGame(this);
                    });
                    
                    // Game over button (simulates hitting obstacle)
                    const gameOverBtn = this.add.text(100, 150, 'GAME OVER', { 
                        fill: '#ff0000', fontSize: '20px', backgroundColor: '#ffffff', padding: {x: 10, y: 5}
                    });
                    gameOverBtn.setInteractive();
                    gameOverBtn.on('pointerdown', () => {
                        if (gameStarted) {
                            gameOver = true;
                            showTestGameOver(this);
                        }
                    });
                }
            }
        };
        
        function startTestGame(scene) {
            log('ðŸš€ Starting game with manual restart system...');
            
            gameStarted = true;
            gameOver = false;
            timerCount = 0;
            
            // Recreate groups (like in fixed meow_mi)
            obstacles = scene.physics.add.group();
            fish = scene.physics.add.group();
            
            // Clear any existing timers
            scene.time.removeAllEvents();
            
            // Create spawn timer
            const timer = scene.time.addEvent({
                delay: 1000,
                callback: function() {
                    timerCount++;
                    log(`âœ… Timer #${timerCount} fired - spawning object`);
                    
                    if (!gameOver) {
                        // Create test object
                        const obj = obstacles.create(500, 200, null);
                        if (obj) {
                            // Simple graphics for visibility
                            const graphics = scene.add.graphics();
                            graphics.fillStyle(0xff0000);
                            graphics.fillRect(0, 0, 20, 20);
                            graphics.generateTexture('testBox', 20, 20);
                            obj.setTexture('testBox');
                            obj.body.setAllowGravity(false);
                            obj.setVelocityX(-100);
                            
                            log(`Object created, group count: ${obstacles.children.entries.length}`);
                        }
                    }
                },
                callbackScope: scene,
                loop: true
            });
            
            log(`Timer created: ${!!timer}, delay: ${timer.delay}`);
        }
        
        function showTestGameOver(scene) {
            log('ðŸ’€ Game Over - showing restart option');
            
            const gameOverText = scene.add.text(300, 150, 'GAME OVER', {
                fontSize: '32px', fill: '#ff0000', fontStyle: 'bold'
            });
            gameOverText.setOrigin(0.5);
            
            const restartBtn = scene.add.text(300, 200, 'RESTART (Manual)', {
                fontSize: '20px', fill: '#000', backgroundColor: '#fff', padding: {x: 10, y: 5}
            });
            restartBtn.setOrigin(0.5);
            restartBtn.setInteractive();
            
            restartBtn.on('pointerdown', () => {
                log('ðŸ”„ Manual restart clicked - NO scene.restart()');
                
                // Clean up
                gameOverText.destroy();
                restartBtn.destroy();
                
                // Reset state
                gameOver = false;
                gameStarted = false;
                timerCount = 0;
                
                log('ðŸš€ Calling startGame directly...');
                
                // Start game directly (like new meow_mi logic)
                startTestGame(scene);
            });
        }
        
        const game = new Phaser.Game(config);
        log('Manual restart test initialized');
        log('1. Click START GAME');
        log('2. Wait for timers to fire and objects to spawn');
        log('3. Click GAME OVER');
        log('4. Click RESTART - should continue working without scene restart');
    </script>
</body>
</html>